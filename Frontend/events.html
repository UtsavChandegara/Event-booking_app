<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - Eventify</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <a href="index.html" class="logo">Eventify</a>
        <nav>
            <ul id="nav-links">
                <!-- Links will be injected by script -->
            </ul>
        </nav>
    </header>

    <main>
        <section class="events-list">
            <h1>Upcoming Events</h1>
            <div id="upcoming-events-grid" class="events-grid">
                <!-- Upcoming Events will be loaded here -->
            </div>

            <h1>Past Events</h1>
            <div id="past-events-grid" class="events-grid">
                <!-- Past Events will be loaded here -->
            </div>
        </section>
    </main>

    <script type="module" src="js/nav.js"></script>
    <script type="module">
        const BASE_URL = 'http://127.0.0.1:3000/api';
        const PLACEHOLDER_300x200 = `data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22300%22%20height%3D%22200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20300%20200%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder%20text%20%7B%20fill%3A%23AAAAAA%3Bfont-weight%3Abold%3Bfont-family%3AArial%2C%20Helvetica%2C%20Open%20Sans%2C%20sans-serif%2C%20monospace%3Bfont-size%3A15pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder%22%3E%3Crect%20width%3D%22300%22%20height%3D%22200%22%20fill%3D%22%23EEEEEE%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%2294.5%22%20y%3D%22106%22%3ENo%20Image%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E`;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`${BASE_URL}/events`);
                if (!response.ok) throw new Error('Failed to fetch events');
                const events = await response.json();

                const now = new Date();
                const upcomingEvents = events.filter(e => new Date(e.date) >= now);
                const pastEvents = events.filter(e => new Date(e.date) < now);

                renderEvents(upcomingEvents, 'upcoming-events-grid', false);
                renderEvents(pastEvents, 'past-events-grid', true);
            } catch (error) {
                console.error('Error loading events:', error);
            }
        });

        function renderEvents(events, containerId, isPast) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (events.length === 0) {
                container.innerHTML = '<p>No events found in this category.</p>';
                return;
            }

            container.innerHTML = events.map(event => {
                const date = new Date(event.date).toLocaleDateString();
                const time = new Date(event.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                let imageUrl = PLACEHOLDER_300x200;
                if (event.imageUrl) {
                    let path = event.imageUrl.trim().replace(/\\/g, "/");
                    const uploadsIndex = path.indexOf("uploads/");
                    if (uploadsIndex !== -1) {
                        path = path.substring(uploadsIndex);
                    }
                    if (path.startsWith("http") || path.startsWith("data:")) {
                        imageUrl = path;
                    } else {
                        imageUrl = `http://127.0.0.1:3000/${path}`;
                    }
                }
                
                // If past event, show "Event Ended" button, otherwise "View Details"
                const actionButton = isPast 
                    ? `<button class="btn" disabled>Event Ended</button>`
                    : `<a href="event-details.html?id=${event._id}" class="btn btn-primary">View Details</a>`;

                return `
                    <div class="event-card">
                        <img src="${imageUrl}" alt="${event.title}" class="event-card-image" onerror="this.onerror=null;this.src='${PLACEHOLDER_300x200}';">
                        <div class="event-card-content">
                            <h3>${event.title}</h3>
                            <p><i class="fas fa-calendar"></i> ${date} at ${time}</p>
                            <p><i class="fas fa-map-marker-alt"></i> ${event.location}</p>
                            <p>â‚¹${event.price}</p>
                            <div class="event-card-footer">
                                ${actionButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>

</body>
</html>
